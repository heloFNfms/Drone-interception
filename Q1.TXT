一、问题建模与总体思路

- 物理场景
  - 导弹 M(t) 从 M0 沿直线匀速指向原点，速度 v_missile。
  - 无人机 D(t) 在 t=1.5s 前等高度匀速朝原点，t=1.5s 投放烟雾弹，烟雾弹平抛 3.6s 在 t=5.1s 起爆形成半径 r_s 的烟球，其后以速度 v_sink 均匀下沉。
  - 目标 B 为竖直圆柱，下底心 (0,200,0)，半径 r_b，高 h_b。
- 遮蔽定义
  - 以烟球球心 S 与导弹位置 M 的连线为圆锥轴线，构造“切线圆锥”：半角 α 满足 sinα = r_s / |MS|。若存在 B 中点 P 使得射线 M→P 穿入该圆锥（且位于烟球之后的圆锥部分），则 B 被遮蔽。
- 总体框架
  - 动态仿真采用变步长时间推进，并在烟球出现阶段对遮蔽进行多重判定（采样+解析几何+蒙特卡洛+微分几何），配合边界敏感性分析，输出遮蔽起止时间与总时长。
二、时间推进：超精细自适应步长

- 实现位置： `animate`
- 方法
  - 基于上一帧时间戳计算 baseDt，并按“关键期/近关键/过渡/常规”四档自适应步长：
    - 关键期（[t_throw, t_boom+2]）：0.5 ms
    - 近关键：1 ms
    - 过渡：2 ms
    - 常规：4 ms
  - 最终 dt = adaptiveDt × speed，实现对烟雾关键时段的时间精度加密。
- 效果
  - 遮蔽开闭沿时间轴的过渡被更精细捕获，毫秒量级定位遮蔽起止，显著降低时间离散误差。
三、几何推进与状态更新

- 实现位置： `stepPhysics`
- 方法
  - 精确解算 M(t)、D(t)、平抛段 S(t) 与下沉段 S(t)，并在烟球阶段可视化切线圆锥用于直观验证。
- 可视化： `drawShadowCone` 辅助调试与解释。
四、遮蔽判定：分层、多模态、稳健

- 主控函数
  - `isCylinderInShadowCone` 负责综合多源证据得出遮蔽结论，并记录采样点数与遮蔽比例用于精度评估。
- 1. 1.
     稠密采样法（主证据）
  - 点采样构成：
    - 轴线采样：沿圆柱中心轴线（z向）多点
    - 表面采样：圆周多角度、多层 z 位
    - 内部采样：圆盘内极坐标均匀分布，z 多层
    - 边缘加密：锥边界附近专门采样
  - 点级判定（标准/高精度两种）
    - 标准点判定： `isPointInShadowCone` 采用锥轴投影与垂距比较，容差 tolerance=0.05，避免数值边界抖动。
    - 高精度点判定： `isPointInShadowConeHighPrecision` 使用 sinα/cosα 严格计算锥半径与更严格容差（1.001 倍）进一步压缩误差。
  - 决策阈值
    - 采样遮蔽比例 shadowRatio 与主阈值 primaryThreshold=0.12 比较（显著低于传统 0.25），提升敏感度。
- 2. 1.
     解析几何法（强证据）
  - `analyticalConeIntersection` 与 `circleIntersectsCone`
  - 思路
    - 将圆柱按若干 z 水平切片为圆，判定每一圆是否与切线圆锥相交。
    - 通过锥的轴向投影、圆心到锥轴的最短距离与随轴距增长的锥半径关系，构建解析判定。
  - 作用
    - 对采样法的“漏检/误判”提供稳定的解析背书，尤其在边界临界时段提高一致性。
- 3. 1.
     蒙特卡洛 + 微分几何（超高精度补充证据）
  - 蒙特卡洛： `performExtraPrecisionCheck`
    - 在圆柱体体积内进行 5000 次均匀随机采样，统计点落入锥内比例，作为概率性强证据。
  - 微分几何： `differentialGeometryIntersection`
    - 将圆柱侧面参数化为 72 条生成线（母线），逐条与圆锥求交。
    - 线段-圆锥相交： `lineIntersectsCone` 以 50 点细采样检验是否进入锥截域。
  - 触发策略
    - 当 shadowRatio 位于边界敏感区间（约 0.08–0.18）或扩展临界区（约 0.05–0.25）时触发，更关注最易误判的临界区。
- 4. 1.
     边界敏感性分析（辅助证据）
  - 几何接近性：圆锥半角与圆柱“角度”近似、烟球中心与圆柱距离近似等联合门限，处理边界模糊地带的稳定性。
五、数值稳定与抗噪处理

- 圆锥内点判定容差从 0.1 缩小到 0.05，减少“锥面附近”抖动导致的误判。
- 多源证据“或”融合（采样结果｜解析几何｜蒙特卡洛/微分几何｜边界分析），显著提高在临界边界附近的一致性与鲁棒性。
- 信息面板精度指标： `updateInfo` 实时回传采样点数与遮蔽比例，遮蔽起止与总时长改为毫秒级展示，便于校核与复现。
六、计算复杂度与性能权衡

- 自适应步长在关键期显著增加时间采样密度，配合 650+ 的确定性采样、5000 次蒙卡与 72×50 的母线采样，计算量有序上升。
- 通过“条件触发”的超高精度路径，仅在必要时段启用昂贵计算，保证整体运行的交互性与实时性。
七、效果与改进总结

- 时间精度：从以往固定步长提升为关键期 0.5 ms 级别，可毫秒级定位 t_on 与 t_off。
- 判定精度：主阈值从 0.25 降至 0.12，并引入多重验证与边界分析，极大降低临界误判率。
- 稳健性：解析几何与微分几何为采样与蒙卡提供强约束，消除“采样偶然性”与“离散噪声”的双重影响。
- 可解释性：切线圆锥可视化与指标面板（采样点数、遮蔽比例、算法等级）让结果可审计、可复核。
八、可扩展性与后续建议

- 将“生成线数量、线段采样密度、蒙卡样本数、阈值带宽”暴露为配置项，结合自适应控制器按时间与几何态势动态调参。
- 解析法可进一步采用严格的锥-圆柱代数判定（闭式条件）替代局部采样，减少对数值容差的依赖。
- 针对 GPU/WebGL 的可并行化蒙卡与母线检查，可以在不降低精度的前提下显著提高帧率。
通过上述分层与多证据融合的策略，代码在 `animate` 、 `stepPhysics` 、 `isCylinderInShadowCone` 等关键模块中实现了“时间高分辨率 + 几何强约束 + 概率稳健化”的组合，使遮蔽起止时刻与总遮蔽时间的计算达到“超高精度算法”的要求，并在临界条件下保持稳定一致的判断。